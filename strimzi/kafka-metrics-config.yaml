# Конфигурация Kafka JMX Exporter для метрик Prometheus
kind: ConfigMap
apiVersion: v1
metadata:
  name: kafka-metrics
  namespace: kafka-cluster
  labels:
    app: strimzi
data:
  kafka-metrics-config.yml: |
    # Метрики брокера Kafka
    lowercaseOutputName: true
    lowercaseOutputLabelNames: true
    rules:
    # Особые случаи и пользовательские имена атрибутов
    - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), topic=(.+), partition=(.*)><>Value
      name: kafka_server_$1_$2
      type: GAUGE
      labels:
       clientId: "$3"
       topic: "$4"
       partition: "$5"
    - pattern: kafka.server<type=(.+), name=(.+), clientId=(.+), brokerHost=(.+), brokerPort=(.+)><>Value
      name: kafka_server_$1_$2
      type: GAUGE
      labels:
       clientId: "$3"
       broker: "$4:$5"
    - pattern: kafka.server<type=(.+), cipher=(.+), protocol=(.+), listener=(.+), networkProcessor=(.+)><>connections
      name: kafka_server_$1_connections_tls_info
      type: GAUGE
      labels:
        cipher: "$2"
        protocol: "$3"
        listener: "$4"
        networkProcessor: "$5"
    - pattern: kafka.server<type=(.+), clientSoftwareName=(.+), clientSoftwareVersion=(.+), listener=(.+), networkProcessor=(.+)><>connections
      name: kafka_server_$1_connections_software
      type: GAUGE
      labels:
        clientSoftwareName: "$2"
        clientSoftwareVersion: "$3"
        listener: "$4"
        networkProcessor: "$5"
    - pattern: "kafka.server<type=(.+), listener=(.+), networkProcessor=(.+)><>(.+):"
      name: kafka_server_$1_$4
      type: GAUGE
      labels:
       listener: "$2"
       networkProcessor: "$3"
    - pattern: kafka.server<type=(.+), listener=(.+), networkProcessor=(.+)><>(.+)
      name: kafka_server_$1_$4
      type: GAUGE
      labels:
       listener: "$2"
       networkProcessor: "$3"
    # Метрики ReplicaManager - LeaderCount, PartitionCount и др.
    - pattern: kafka.server<type=ReplicaManager, name=(.+)><>(Value|Count)
      name: kafka_server_replicamanager_$1
      type: GAUGE
    # Метрики KafkaRequestHandlerPool
    - pattern: kafka.server<type=KafkaRequestHandlerPool, name=(.+)><>(.+)
      name: kafka_server_kafkarequesthandlerpool_$1_$2
      type: GAUGE
    # Метрики контроллера
    - pattern: kafka.controller<type=(.+), name=(.+)><>(Count|Value)
      name: kafka_controller_$1_$2
      type: GAUGE
    # Метрики сетевых запросов Kafka
    - pattern: kafka.network<type=(.+), name=(.+), request=(.+), error=(.+)><>Count
      name: kafka_network_$1_$2_errors_total
      type: COUNTER
      labels:
        request: "$3"
        error: "$4"
    - pattern: kafka.network<type=(.+), name=(.+), request=(.+), version=(.+)><>(Count|OneMinuteRate)
      name: kafka_network_$1_$2
      type: GAUGE
      labels:
        request: "$3"
        version: "$4"
    - pattern: kafka.network<type=(.+), name=(.+), request=(.+)><>Count
      name: kafka_network_$1_$2_total
      type: COUNTER
      labels:
        request: "$3"
    - pattern: kafka.network<type=(.+), name=(.+), request=(.+)><>(\d+)thPercentile
      name: kafka_network_$1_$2
      type: GAUGE
      labels:
        request: "$3"
        quantile: "0.$4"
    - pattern: kafka.network<type=(.+), name=(.+), request=(.+)><>(.+)
      name: kafka_network_$1_$2
      type: GAUGE
      labels:
        request: "$3"
    - pattern: kafka.network<type=(.+), name=(.+)><>(.+)
      name: kafka_network_$1_$2_$3
      type: GAUGE
    # Метрики логов
    - pattern: kafka.log<type=Log, name=(.+), topic=(.+), partition=(.+)><>Value
      name: kafka_log_$1
      type: GAUGE
      labels:
        topic: "$2"
        partition: "$3"
    - pattern: kafka.log<type=LogManager, name=(.+)><>(.+)
      name: kafka_log_logmanager_$1_$2
      type: GAUGE
    # Метрики кластера
    - pattern: kafka.cluster<type=(.+), name=(.+), topic=(.+), partition=(.+)><>Value
      name: kafka_cluster_$1_$2
      type: GAUGE
      labels:
        topic: "$3"
        partition: "$4"
    # Метрики координатора
    - pattern: kafka.coordinator.group<type=(.+), name=(.+)><>(Count|Value)
      name: kafka_coordinator_group_$1_$2
      type: GAUGE
    - pattern: kafka.coordinator.transaction<type=(.+), name=(.+)><>(Count|Value)
      name: kafka_coordinator_transaction_$1_$2
      type: GAUGE
    # Метрики KRaft (Raft Channel)
    - pattern: kafka.server<type=raft-channel-metrics><>(.+)
      name: kafka_server_raftchannelmetrics_$1
      type: GAUGE
    # Метрики KRaft (Raft Metrics)
    - pattern: kafka.server<type=raft-metrics><>(.+)
      name: kafka_server_raftmetrics_$1
      type: GAUGE
    # Метрики KRaft Controller
    - pattern: kafka.controller<type=KafkaController, name=(.+)><>(Count|Value)
      name: kafka_controller_kafkacontroller_$1
      type: GAUGE
    # Общие счётчики в секунду для остальных метрик
    - pattern: kafka.(\w+)<type=(.+), name=(.+)PerSec\w*, (.+)=(.+), (.+)=(.+)><>Count
      name: kafka_$1_$2_$3_total
      type: COUNTER
      labels:
        "$4": "$5"
        "$6": "$7"
    - pattern: kafka.(\w+)<type=(.+), name=(.+)PerSec\w*, (.+)=(.+)><>Count
      name: kafka_$1_$2_$3_total
      type: COUNTER
      labels:
        "$4": "$5"
    - pattern: kafka.(\w+)<type=(.+), name=(.+)PerSec\w*><>Count
      name: kafka_$1_$2_$3_total
      type: COUNTER
    # Общие gauges
    - pattern: kafka.(\w+)<type=(.+), name=(.+), (.+)=(.+), (.+)=(.+)><>Value
      name: kafka_$1_$2_$3
      type: GAUGE
      labels:
        "$4": "$5"
        "$6": "$7"
    - pattern: kafka.(\w+)<type=(.+), name=(.+), (.+)=(.+)><>Value
      name: kafka_$1_$2_$3
      type: GAUGE
      labels:
        "$4": "$5"
    - pattern: kafka.(\w+)<type=(.+), name=(.+)><>Value
      name: kafka_$1_$2_$3
      type: GAUGE
    # Дополнительные универсальные правила
    - pattern: kafka.(\w+)<type=(.+), name=(.+), (.+)=(.+)><>Count
      name: kafka_$1_$2_$3_count
      type: COUNTER
      labels:
        "$4": "$5"
    - pattern: kafka.(\w+)<type=(.+), name=(.+)><>Count
      name: kafka_$1_$2_$3_count
      type: COUNTER
