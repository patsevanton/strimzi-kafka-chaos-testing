{
  "annotations": {
    "list": [
      {
        "builtIn": 1,
        "datasource": { "type": "grafana", "uid": "-- Grafana --" },
        "enable": true,
        "hide": true,
        "iconColor": "rgba(0, 211, 255, 1)",
        "name": "Annotations & Alerts",
        "type": "dashboard"
      }
    ]
  },
  "description": "Redis и верификация доставки по docs/delivery-verification-critique.md: latency и нагрузка на Redis (п.7), ошибки записи/доступность (п.1), SLO по задержке — pending и old (п.4), received и hash mismatch.",
  "editable": true,
  "fiscalYearStartMonth": 0,
  "graphTooltip": 0,
  "id": null,
  "links": [],
  "liveNow": false,
  "panels": [
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
      "id": 100,
      "panels": [],
      "description": "Секция метрик Redis: задержки ответа, нагрузка на инстанс и доступность. См. п.7 и п.1 критикала (docs/delivery-verification-critique.md).",
      "title": "Redis — latency, нагрузка, доступность (п.7, п.1)",
      "type": "row"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Число подключённых клиентов к Redis. Рост при высокой нагрузке; отказ или недоступность Redis влияют на Producer и Consumer (запись и чтение ключей верификации).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 6, "x": 0, "y": 1 },
      "id": 101,
      "options": { "colorMode": "value", "graphMode": "area", "justifyMode": "auto", "orientation": "auto", "reduceOptions": { "calcs": ["lastNotNull"], "fields": "", "values": false }, "textMode": "auto" },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "redis_connected_clients",
          "legendFormat": "clients",
          "refId": "A"
        }
      ],
      "title": "Redis: Connected Clients",
      "type": "stat"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Скорость выполнения команд Redis (операций в секунду). Отражает нагрузку от Producer (SET, INCR), Consumer (GET, DEL, INCR) и периодического SCAN для подсчёта pending/old по SLO.",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "ops"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 9, "x": 6, "y": 1 },
      "id": 102,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "sum(rate(redis_commands_processed_total[5m]))",
          "legendFormat": "commands/s",
          "refId": "A"
        }
      ],
      "title": "Redis: Commands Rate",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Объём памяти, используемой Redis. Рост при накоплении ключей без TTL; при длительном отказе consumer или «сиротах» ключи могут копиться (п.6 критикала).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "bytes"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 9, "x": 15, "y": 1 },
      "id": 103,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "redis_memory_used_bytes",
          "legendFormat": "used",
          "refId": "A"
        }
      ],
      "title": "Redis: Memory Used",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Число отклонённых подключений к Redis за последние 5 минут. Рост указывает на перегрузку или отказ инстанса (п.7 критикала).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 7 },
      "id": 104,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "increase(redis_rejected_connections_total[5m])",
          "legendFormat": "rejected",
          "refId": "A"
        }
      ],
      "title": "Redis: Rejected Connections (5m)",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Задержка выполнения команд Redis (суммарное время по типам команд за 5 мин). Позволяет оценить latency Redis и влияние на Producer/Consumer (п.7 критикала). Метрика доступна при поддержке со стороны экспортера.",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "s"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 7 },
      "id": 105,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "sum(rate(redis_commands_duration_seconds_total[5m])) by (cmd)",
          "legendFormat": "{{cmd}}",
          "refId": "A"
        }
      ],
      "title": "Redis: Command Latency (rate / p99)",
      "type": "timeseries"
    },
    {
      "collapsed": false,
      "gridPos": { "h": 1, "w": 24, "x": 0, "y": 13 },
      "id": 106,
      "panels": [],
      "description": "Секция верификации доставки: счётчики сообщений в Redis (ожидающие, старше SLO), скорость полученных и проверенных по Redis, несовпадения хеша (п.4 критикала).",
      "title": "Delivery verification — SLO по задержке, pending / old / received (п.4)",
      "type": "row"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Число ключей в Redis, ожидающих обработки: сообщение отправлено в Kafka и записано в Redis, но consumer ещё не обработал и не удалил ключ. Рост при отставании consumer (п.4 критикала).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 8, "x": 0, "y": 14 },
      "id": 107,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "redis_pending_messages",
          "legendFormat": "pending {{pod}}",
          "refId": "A"
        }
      ],
      "title": "Pending Messages (in Redis)",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Текущее число ключей в Redis старше порога REDIS_SLO_SECONDS (gauge). Уменьшается, когда consumer забирает сообщение и удаляет ключ из Redis; растёт, когда новые сообщения переходят в «старые». Любое значение > 0 — нарушение SLO (п.4). Один ряд — max по подам (все поды видят один Redis).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 8, "x": 8, "y": 14 },
      "id": 108,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "max(redis_pending_old_messages)",
          "legendFormat": "old (SLO)",
          "refId": "A"
        }
      ],
      "title": "Pending Old (SLO Breach)",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Скорость сообщений, полученных и верифицированных через Redis (удаление ключа и INCR received). Учитывает только успешную проверку хеша. При повторной доставке счётчик может быть завышен (п.4 критикала).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 8, "x": 16, "y": 14 },
      "id": 109,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "rate(kafka_consumer_messages_received_total[5m])",
          "legendFormat": "{{topic}} p{{partition}}",
          "refId": "A"
        }
      ],
      "title": "Consumer: Received Rate (verified via Redis)",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Число сообщений, у которых хеш тела не совпал с значением в Redis. Указывает на искажение данных в пути (Kafka, сеть, код) или рассинхрон; см. п.1 критикала.",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}, {"color": "red", "value": 1}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 12, "x": 0, "y": 20 },
      "id": 110,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "increase(kafka_consumer_redis_hash_mismatch_total[5m])",
          "legendFormat": "{{topic}} p{{partition}}",
          "refId": "A"
        }
      ],
      "title": "Consumer: Redis Hash Mismatch (5m)",
      "type": "timeseries"
    },
    {
      "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
      "description": "Совместный график ожидающих (pending) и просроченных по SLO (old). Рост pending при нулевом old означает, что consumer отстаёт, но все сообщения обрабатываются быстрее порога SLO (п.4 критикала).",
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "palette-classic" },
          "custom": { "axisCenteredZero": false, "axisLabel": "", "axisPlacement": "auto", "drawStyle": "line", "fillOpacity": 10, "lineInterpolation": "linear", "lineWidth": 1, "pointSize": 5, "showPoints": "never", "spanNulls": false, "stacking": { "group": "A", "mode": "none" }, "thresholdsStyle": { "mode": "off" } },
          "mappings": [],
          "thresholds": { "mode": "absolute", "steps": [{"color": "green", "value": null}] },
          "unit": "short"
        },
        "overrides": []
      },
      "gridPos": { "h": 6, "w": 12, "x": 12, "y": 20 },
      "id": 111,
      "options": { "legend": { "calcs": ["lastNotNull", "max"], "displayMode": "list", "placement": "bottom", "showLegend": true }, "tooltip": { "mode": "multi", "sort": "none" } },
      "targets": [
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "max(redis_pending_messages)",
          "legendFormat": "pending",
          "refId": "A"
        },
        {
          "datasource": { "type": "prometheus", "uid": "${DS_VICTORIAMETRICS}" },
          "editorMode": "code",
          "expr": "max(redis_pending_old_messages)",
          "legendFormat": "old (SLO)",
          "refId": "B"
        }
      ],
      "title": "Pending vs Old (SLO)",
      "type": "timeseries"
    }
  ],
  "refresh": "30s",
  "schemaVersion": 38,
  "style": "dark",
  "tags": ["redis", "delivery-verification", "slo", "kafka"],
  "templating": {
    "list": [
      {
        "current": {},
        "hide": 0,
        "includeAll": false,
        "label": "datasource",
        "multi": false,
        "name": "DS_VICTORIAMETRICS",
        "options": [],
        "query": "prometheus",
        "refresh": 1,
        "regex": "",
        "skipUrlSync": false,
        "type": "datasource"
      }
    ]
  },
  "time": { "from": "now-1h", "to": "now" },
  "timepicker": {},
  "timezone": "",
  "title": "Redis & Delivery Verification",
  "uid": "redis-delivery-verification",
  "version": 1,
  "weekStart": ""
}
